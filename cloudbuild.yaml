steps:
- name: gcr.io/cloud-builders/docker
  args: ['build', '-t', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA', '.']
  id: 'Build Docker image'

- name: gcr.io/cloud-builders/docker
  args: ['push', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA']
  id: 'Push Docker image'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  entrypoint: gcloud
  args: ['run', 'deploy', '$_SERVICE_NAME', 
         '--image', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA', 
         '--platform', 'managed', 
         '--region', '$_REGION', 
         '--allow-unauthenticated', 
         '--set-env-vars', "ConnectionStrings__DefaultConnection=Server=/cloudsql/event-management-system-430621:us-central1:eventmanagementsystem;Database=EventManagementFinalNewNew;User Id=sqlserver;Password=event@123",
         '--add-cloudsql-instances', 'event-management-system-430621:us-central1:eventmanagementsystem']
  id: 'Deploy to Cloud Run'

images:
- '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA'

timeout: 1200s
